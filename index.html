<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Microplastic Detection Laboratory</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --darker: #0f172a;
            --light: #f8fafc;
            --gray: #94a3b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker) 0%, #1e3a8a 100%);
            color: var(--light);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 30px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid rgba(37, 99, 235, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            font-size: 2.8rem;
            background: linear-gradient(90deg, #3b82f6, #06b6d4, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            font-size: 1.2rem;
            color: var(--gray);
            max-width: 800px;
            margin: 0 auto 20px;
        }
        
        .tagline {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            background: rgba(37, 99, 235, 0.1);
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 1rem;
            border: 1px solid rgba(37, 99, 235, 0.3);
        }
        
        .tagline i {
            color: #3b82f6;
        }
        
        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1100px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* Panels */
        .panel {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(37, 99, 235, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-5px);
        }
        
        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #3b82f6;
        }
        
        .panel-title i {
            font-size: 1.5rem;
        }
        
        /* Control Panel */
        .sample-selector {
            margin-bottom: 30px;
        }
        
        .sample-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .sample-options {
                grid-template-columns: 1fr;
            }
        }
        
        .sample-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(37, 99, 235, 0.3);
            border-radius: 15px;
            padding: 20px;
            color: var(--light);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .sample-btn:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.2);
        }
        
        .sample-btn.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.15);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
        }
        
        .sample-icon {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #3b82f6;
        }
        
        .sample-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .sample-desc {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        /* Sliders */
        .slider-container {
            margin-bottom: 25px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .slider-value {
            color: var(--primary);
            font-weight: 600;
        }
        
        .slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 5px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid var(--darker);
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            color: var(--primary);
            border: 2px solid rgba(37, 99, 235, 0.3);
        }
        
        .btn-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 2px solid rgba(245, 158, 11, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), #1e40af);
        }
        
        /* Results Panel */
        .results-container {
            min-height: 500px;
        }
        
        .results-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 500px;
            text-align: center;
            color: var(--gray);
        }
        
        .results-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #475569;
        }
        
        .results-content {
            display: none;
        }
        
        .result-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .result-title {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .result-confidence {
            background: rgba(37, 99, 235, 0.1);
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
        }
        
        /* RGB Display */
        .rgb-display {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .rgb-display {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        .rgb-channel {
            flex: 1;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .rgb-red {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        .rgb-green {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }
        
        .rgb-blue {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        
        .rgb-value {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        
        /* Probability Bars */
        .probability-chart {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .probability-bar {
            margin-bottom: 15px;
        }
        
        .probability-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .probability-name {
            font-weight: 600;
        }
        
        .probability-value {
            color: var(--primary);
            font-weight: 600;
        }
        
        .probability-meter {
            height: 12px;
            background: rgba(30, 41, 59, 1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .probability-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 1s ease;
        }
        
        /* Dashboard */
        .dashboard {
            grid-column: 1 / -1;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            border: 2px solid rgba(37, 99, 235, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border-top: 5px solid var(--primary);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1rem;
            color: var(--gray);
        }
        
        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 20px;
        }
        
        @media (max-width: 1100px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-box {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 20px;
            height: 350px;
        }
        
        /* Test History */
        .test-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            padding-right: 10px;
        }
        
        .test-history::-webkit-scrollbar {
            width: 8px;
        }
        
        .test-history::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }
        
        .test-history::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        .history-item {
            background: rgba(30, 41, 59, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
        }
        
        .history-polymer {
            font-weight: 600;
        }
        
        .history-confidence {
            font-weight: 600;
            color: var(--primary);
        }
        
        .history-time {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            margin-top: 50px;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid rgba(37, 99, 235, 0.1);
        }
        
        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .status-online {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-processing {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Polymer Colors */
        .polymer-pe { color: #ef4444; }
        .polymer-pp { color: #3b82f6; }
        .polymer-pet { color: #10b981; }
        .polymer-ps { color: #f59e0b; }
        .polymer-pvc { color: #8b5cf6; }
        .polymer-none { color: #94a3b8; }
        
        /* Instructions */
        .instructions {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-microscope"></i> Virtual Microplastic Detection Laboratory</h1>
            <p class="subtitle">Simulate fluorescence-based detection of microplastics using virtual RGB sensors and machine learning. Test different polymers and analyze results in real-time.</p>
            <div class="tagline">
                <i class="fas fa-flask"></i> Virtual Laboratory | 
                <i class="fas fa-robot"></i> ML-Powered | 
                <i class="fas fa-chart-line"></i> Real-time Analytics
            </div>
            <div class="status-indicator status-online">
                <i class="fas fa-circle"></i> System Online - Ready for Testing
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Control Panel -->
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-sliders-h"></i> Control Panel</h2>
                
                <div class="sample-selector">
                    <h3>Select Sample Type</h3>
                    <div class="sample-options">
                        <button class="sample-btn active" data-sample="PE">
                            <div class="sample-icon"><i class="fas fa-shopping-bag"></i></div>
                            <div class="sample-name polymer-pe">Polyethylene (PE)</div>
                            <div class="sample-desc">Plastic bags, bottles, packaging</div>
                        </button>
                        <button class="sample-btn" data-sample="PP">
                            <div class="sample-icon"><i class="fas fa-utensils"></i></div>
                            <div class="sample-name polymer-pp">Polypropylene (PP)</div>
                            <div class="sample-desc">Food containers, automotive parts</div>
                        </button>
                        <button class="sample-btn" data-sample="PET">
                            <div class="sample-icon"><i class="fas fa-wine-bottle"></i></div>
                            <div class="sample-name polymer-pet">PET</div>
                            <div class="sample-desc">Water bottles, clothing fibers</div>
                        </button>
                        <button class="sample-btn" data-sample="PS">
                            <div class="sample-icon"><i class="fas fa-mug-hot"></i></div>
                            <div class="sample-name polymer-ps">Polystyrene (PS)</div>
                            <div class="sample-desc">Foam cups, packaging materials</div>
                        </button>
                        <button class="sample-btn" data-sample="PVC">
                            <div class="sample-icon"><i class="fas fa-tint-slash"></i></div>
                            <div class="sample-name polymer-pvc">PVC</div>
                            <div class="sample-desc">Pipes, vinyl products, flooring</div>
                        </button>
                        <button class="sample-btn" data-sample="NONE">
                            <div class="sample-icon"><i class="fas fa-tint"></i></div>
                            <div class="sample-name polymer-none">Clean Water</div>
                            <div class="sample-desc">No microplastics - control sample</div>
                        </button>
                    </div>
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span><i class="fas fa-vial"></i> Sample Quality</span>
                        <span class="slider-value" id="qualityValue">80%</span>
                    </div>
                    <input type="range" class="slider" id="qualitySlider" min="10" max="100" value="80">
                    <div style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
                        Lower quality = more noise in measurements
                    </div>
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span><i class="fas fa-sun"></i> Ambient Light</span>
                        <span class="slider-value" id="lightValue">50 lux</span>
                    </div>
                    <input type="range" class="slider" id="lightSlider" min="0" max="200" value="50">
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span><i class="fas fa-lightbulb"></i> UV Intensity</span>
                        <span class="slider-value" id="uvValue">85%</span>
                    </div>
                    <input type="range" class="slider" id="uvSlider" min="0" max="100" value="85">
                    <div style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
                        Higher UV = stronger fluorescence
                    </div>
                </div>

                <div class="instructions">
                    <h3><i class="fas fa-info-circle"></i> How to Use</h3>
                    <ol>
                        <li>Select sample type from options above</li>
                        <li>Adjust sample quality slider</li>
                        <li>Click 'Run Test' to analyze</li>
                        <li>Use 'Auto Test' for multiple samples</li>
                    </ol>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="runTestBtn">
                        <i class="fas fa-play"></i> Run Single Test
                    </button>
                    <button class="btn btn-secondary" id="autoTestBtn">
                        <i class="fas fa-cogs"></i> Auto Test (5 samples)
                    </button>
                    <button class="btn btn-warning" id="resetBtn">
                        <i class="fas fa-redo"></i> Reset Lab
                    </button>
                </div>

                <div class="test-history" id="testHistory">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-history"></i> Test History</h3>
                    <!-- History items will be added here -->
                </div>
            </div>

            <!-- Results Panel -->
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-chart-bar"></i> Test Results</h2>
                
                <div class="results-container">
                    <div class="results-placeholder" id="resultsPlaceholder">
                        <i class="fas fa-flask"></i>
                        <h3>No Test Results Yet</h3>
                        <p>Select a sample and click "Run Test" to analyze</p>
                        <p style="margin-top: 20px; color: var(--gray); font-size: 0.9rem;">
                            <i class="fas fa-lightbulb"></i> Try testing Polyethylene to see high red fluorescence
                        </p>
                    </div>

                    <div class="results-content" id="resultsContent">
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-title" id="resultPolymer">Polyethylene (PE)</div>
                                <div class="result-confidence" id="resultConfidence">92.3%</div>
                            </div>
                            
                            <div class="rgb-display">
                                <div class="rgb-channel rgb-red">
                                    <div class="rgb-value" id="rValue">185</div>
                                    <div>Red Fluorescence</div>
                                    <div style="font-size: 0.9rem; color: #f87171; margin-top: 5px;">
                                        High = PE indicator
                                    </div>
                                </div>
                                <div class="rgb-channel rgb-green">
                                    <div class="rgb-value" id="gValue">92</div>
                                    <div>Green Fluorescence</div>
                                    <div style="font-size: 0.9rem; color: #4ade80; margin-top: 5px;">
                                        High = PP indicator
                                    </div>
                                </div>
                                <div class="rgb-channel rgb-blue">
                                    <div class="rgb-value" id="bValue">42</div>
                                    <div>Blue Fluorescence</div>
                                    <div style="font-size: 0.9rem; color: #60a5fa; margin-top: 5px;">
                                        Generally low for plastics
                                    </div>
                                </div>
                            </div>

                            <div id="resultInterpretation" style="padding: 15px; background: rgba(37, 99, 235, 0.1); border-radius: 8px;">
                                <strong><i class="fas fa-microscope"></i> Interpretation:</strong> Microplastics detected. High red fluorescence indicates Polyethylene particles commonly found in plastic bags and bottles.
                            </div>
                        </div>

                        <div class="probability-chart">
                            <h3 style="margin-bottom: 20px;"><i class="fas fa-chart-pie"></i> Detection Probabilities</h3>
                            <div id="probabilityBars">
                                <!-- Probability bars will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <h2 class="panel-title"><i class="fas fa-tachometer-alt"></i> Analytics Dashboard</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTests">0</div>
                    <div class="stat-label">Total Tests Run</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statDetections">0</div>
                    <div class="stat-label">Microplastic Detections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRate">0%</div>
                    <div class="stat-label">Detection Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statConfidence">0%</div>
                    <div class="stat-label">Average Confidence</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-box" id="rgbChart"></div>
                <div class="chart-box" id="historyChart"></div>
                <div class="chart-box" id="polymerChart"></div>
                <div class="chart-box" id="confidenceChart"></div>
            </div>
        </div>

        <footer class="footer">
            <p><strong>Virtual Microplastic Detection Laboratory</strong> | Educational Simulation Tool</p>
            <p>This simulation demonstrates fluorescence-based microplastic detection using RGB sensors and machine learning.</p>
            <p style="margin-top: 15px; font-size: 0.8rem;">
                <i class="fas fa-code"></i> Built with HTML, CSS, JavaScript & Plotly | 
                <i class="fas fa-graduation-cap"></i> For Educational Purposes
            </p>
        </footer>
    </div>

    <script>
        // Virtual Microplastic Detection System
        class VirtualMicroplasticDetector {
            constructor() {
                this.testHistory = [];
                this.stats = {
                    tests: 0,
                    detections: 0,
                    totalConfidence: 0
                };
                
                // Polymer fluorescence signatures based on Nile Red staining
                this.polymerSignatures = {
                    'PE': { 
                        name: 'Polyethylene (PE)', 
                        R: 185, G: 92, B: 42, 
                        color: '#ef4444',
                        description: 'Strong red fluorescence. Common in plastic bags, bottles, packaging.',
                        commonSources: 'Plastic bags, bottles, packaging materials, toys'
                    },
                    'PP': { 
                        name: 'Polypropylene (PP)', 
                        R: 125, G: 155, B: 82, 
                        color: '#3b82f6',
                        description: 'High green fluorescence. Used in food containers, automotive parts.',
                        commonSources: 'Food containers, automotive parts, textiles, medical devices'
                    },
                    'PET': { 
                        name: 'PET', 
                        R: 140, G: 120, B: 90, 
                        color: '#10b981',
                        description: 'Moderate fluorescence. Found in water bottles, clothing.',
                        commonSources: 'Water bottles, clothing fibers, food packaging'
                    },
                    'PS': { 
                        name: 'Polystyrene (PS)', 
                        R: 160, G: 100, B: 110, 
                        color: '#f59e0b',
                        description: 'Distinct fluorescence pattern. Used in foam products.',
                        commonSources: 'Foam cups, packaging materials, disposable cutlery'
                    },
                    'PVC': { 
                        name: 'PVC', 
                        R: 130, G: 140, B: 75, 
                        color: '#8b5cf6',
                        description: 'Moderate fluorescence. Common in pipes and vinyl products.',
                        commonSources: 'Pipes, vinyl flooring, cables, medical tubing'
                    },
                    'NONE': { 
                        name: 'Clean Water', 
                        R: 35, G: 35, B: 35, 
                        color: '#94a3b8',
                        description: 'Low fluorescence across all channels.',
                        commonSources: 'No microplastics detected'
                    }
                };
            }
            
            simulateTest(sampleType, quality, light, uv) {
                // Get base values for the selected polymer
                const base = this.polymerSignatures[sampleType];
                
                // Apply variations based on quality and conditions
                const noise = (100 - quality) / 50; // More noise for lower quality
                const lightEffect = light / 200; // Ambient light adds baseline
                const uvEffect = uv / 100; // UV excites fluorescence
                
                // Generate realistic RGB values with variations
                const r = Math.max(0, Math.min(255, 
                    base.R * (1 + uvEffect * 0.2) * (1 + lightEffect * 0.1) + 
                    (Math.random() - 0.5) * 20 * noise
                ));
                
                const g = Math.max(0, Math.min(255, 
                    base.G * (1 + uvEffect * 0.15) * (1 + lightEffect * 0.1) + 
                    (Math.random() - 0.5) * 20 * noise
                ));
                
                const b = Math.max(0, Math.min(255, 
                    base.B * (1 + uvEffect * 0.1) * (1 + lightEffect * 0.1) + 
                    (Math.random() - 0.5) * 20 * noise
                ));
                
                // Simulate ML model predictions based on fluorescence patterns
                let probabilities = {};
                let confidence = 0;
                
                // Simulated ML logic based on RGB patterns
                if (r > 150 && g < 120 && b < 60) {
                    // Pattern for PE
                    probabilities = { 
                        'PE': 0.85 * (quality/100), 
                        'PP': 0.10 * (quality/100), 
                        'PET': 0.03 * (quality/100),
                        'NONE': 0.02 * (quality/100)
                    };
                } else if (g > 140 && r > 100 && r < 140 && b > 60 && b < 100) {
                    // Pattern for PP
                    probabilities = { 
                        'PP': 0.82 * (quality/100), 
                        'PE': 0.12 * (quality/100), 
                        'PET': 0.04 * (quality/100),
                        'NONE': 0.02 * (quality/100)
                    };
                } else if (r < 50 && g < 50 && b < 50) {
                    // Pattern for clean water
                    probabilities = { 
                        'NONE': 0.92 * (quality/100), 
                        'PE': 0.04 * (quality/100), 
                        'PP': 0.03 * (quality/100),
                        'PET': 0.01 * (quality/100)
                    };
                } else if (r > 130 && r < 170 && g > 110 && g < 140 && b > 70 && b < 110) {
                    // Pattern for PET
                    probabilities = { 
                        'PET': 0.78 * (quality/100), 
                        'PE': 0.12 * (quality/100), 
                        'PP': 0.08 * (quality/100),
                        'NONE': 0.02 * (quality/100)
                    };
                } else {
                    // Mixed or unclear signal
                    probabilities = { 
                        'PE': 0.30 * (quality/100), 
                        'PP': 0.30 * (quality/100), 
                        'PET': 0.20 * (quality/100),
                        'PS': 0.10 * (quality/100),
                        'PVC': 0.05 * (quality/100),
                        'NONE': 0.05 * (quality/100)
                    };
                }
                
                // Normalize probabilities to sum to 1
                const total = Object.values(probabilities).reduce((a, b) => a + b, 0);
                Object.keys(probabilities).forEach(key => {
                    probabilities[key] /= total;
                });
                
                // Determine the most likely polymer
                let predictedPolymer = 'NONE';
                let maxProb = 0;
                for (const [polymer, prob] of Object.entries(probabilities)) {
                    if (prob > maxProb) {
                        maxProb = prob;
                        predictedPolymer = polymer;
                    }
                }
                
                confidence = maxProb;
                
                // Create test result
                const result = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    sampleType: sampleType,
                    predictedPolymer: predictedPolymer,
                    confidence: confidence,
                    probabilities: probabilities,
                    rgb: {
                        R: Math.round(r),
                        G: Math.round(g),
                        B: Math.round(b)
                    },
                    conditions: {
                        quality: quality,
                        light: light,
                        uv: uv
                    },
                    detected: predictedPolymer !== 'NONE'
                };
                
                // Update statistics
                this.stats.tests++;
                this.stats.totalConfidence += confidence;
                if (result.detected) {
                    this.stats.detections++;
                }
                
                // Add to history (most recent first)
                this.testHistory.unshift(result);
                if (this.testHistory.length > 10) {
                    this.testHistory = this.testHistory.slice(0, 10);
                }
                
                return result;
            }
            
            getStatistics() {
                const avgConfidence = this.stats.tests > 0 ? 
                    (this.stats.totalConfidence / this.stats.tests) * 100 : 0;
                const detectionRate = this.stats.tests > 0 ? 
                    (this.stats.detections / this.stats.tests) * 100 : 0;
                
                return {
                    tests: this.stats.tests,
                    detections: this.stats.detections,
                    detectionRate: detectionRate,
                    avgConfidence: avgConfidence
                };
            }
            
            reset() {
                this.testHistory = [];
                this.stats = {
                    tests: 0,
                    detections: 0,
                    totalConfidence: 0
                };
            }
        }

        // Initialize the virtual detector
        const detector = new VirtualMicroplasticDetector();
        
        // DOM Elements
        const sampleButtons = document.querySelectorAll('.sample-btn');
        const runTestBtn = document.getElementById('runTestBtn');
        const autoTestBtn = document.getElementById('autoTestBtn');
        const resetBtn = document.getElementById('resetBtn');
        const qualitySlider = document.getElementById('qualitySlider');
        const lightSlider = document.getElementById('lightSlider');
        const uvSlider = document.getElementById('uvSlider');
        const qualityValue = document.getElementById('qualityValue');
        const lightValue = document.getElementById('lightValue');
        const uvValue = document.getElementById('uvValue');
        const resultsPlaceholder = document.getElementById('resultsPlaceholder');
        const resultsContent = document.getElementById('resultsContent');
        const testHistoryDiv = document.getElementById('testHistory');
        
        // Result display elements
        const resultPolymer = document.getElementById('resultPolymer');
        const resultConfidence = document.getElementById('resultConfidence');
        const rValue = document.getElementById('rValue');
        const gValue = document.getElementById('gValue');
        const bValue = document.getElementById('bValue');
        const resultInterpretation = document.getElementById('resultInterpretation');
        const probabilityBars = document.getElementById('probabilityBars');
        
        // Statistics elements
        const statTests = document.getElementById('statTests');
        const statDetections = document.getElementById('statDetections');
        const statRate = document.getElementById('statRate');
        const statConfidence = document.getElementById('statConfidence');
        
        // Chart containers
        const rgbChartContainer = document.getElementById('rgbChart');
        const historyChartContainer = document.getElementById('historyChart');
        const polymerChartContainer = document.getElementById('polymerChart');
        const confidenceChartContainer = document.getElementById('confidenceChart');
        
        // Current selected sample
        let selectedSample = 'PE';
        
        // Event Listeners
        sampleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                sampleButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedSample = btn.dataset.sample;
                
                // Update ambient light display for sample change
                const statusIndicator = document.querySelector('.status-indicator');
                statusIndicator.innerHTML = `<i class="fas fa-circle"></i> Selected: ${detector.polymerSignatures[selectedSample].name}`;
            });
        });
        
        qualitySlider.addEventListener('input', () => {
            qualityValue.textContent = `${qualitySlider.value}%`;
        });
        
        lightSlider.addEventListener('input', () => {
            lightValue.textContent = `${lightSlider.value} lux`;
        });
        
        uvSlider.addEventListener('input', () => {
            uvValue.textContent = `${uvSlider.value}%`;
        });
        
        runTestBtn.addEventListener('click', runTest);
        autoTestBtn.addEventListener('click', runAutoTest);
        resetBtn.addEventListener('click', resetLab);
        
        // Initialize charts
        initializeCharts();
        
        // Functions
        function runTest() {
            // Show processing state
            const originalText = runTestBtn.innerHTML;
            runTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            runTestBtn.disabled = true;
            
            // Update status
            const statusIndicator = document.querySelector('.status-indicator');
            statusIndicator.className = 'status-indicator status-processing';
            statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Processing Sample...';
            
            // Simulate processing delay
            setTimeout(() => {
                const quality = parseInt(qualitySlider.value);
                const light = parseInt(lightSlider.value);
                const uv = parseInt(uvSlider.value);
                
                // Run virtual test
                const result = detector.simulateTest(selectedSample, quality, light, uv);
                
                // Display results
                displayResults(result);
                
                // Update UI
                updateTestHistory();
                updateStatistics();
                updateCharts();
                
                // Reset button state
                runTestBtn.innerHTML = originalText;
                runTestBtn.disabled = false;
                
                // Update status
                statusIndicator.className = 'status-indicator status-online';
                const polymerName = detector.polymerSignatures[result.predictedPolymer].name;
                statusIndicator.innerHTML = `<i class="fas fa-circle"></i> Test Complete: ${polymerName}`;
                
            }, 1000);
        }
        
        function runAutoTest() {
            const originalText = autoTestBtn.innerHTML;
            autoTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            autoTestBtn.disabled = true;
            
            const samples = ['PE', 'PP', 'PET', 'PS', 'PVC', 'NONE'];
            let completed = 0;
            
            // Update status
            const statusIndicator = document.querySelector('.status-indicator');
            statusIndicator.className = 'status-indicator status-processing';
            
            // Run 5 tests with random samples
            const interval = setInterval(() => {
                if (completed >= 5) {
                    clearInterval(interval);
                    autoTestBtn.innerHTML = originalText;
                    autoTestBtn.disabled = false;
                    
                    // Update status
                    statusIndicator.className = 'status-indicator status-online';
                    statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Auto Test Complete';
                    
                    // Show summary
                    const stats = detector.getStatistics();
                    showNotification(`Auto test completed!<br><br>Tests run: ${stats.tests}<br>Detections: ${stats.detections}<br>Detection rate: ${stats.detectionRate.toFixed(1)}%`);
                    return;
                }
                
                // Update status
                statusIndicator.innerHTML = `<i class="fas fa-circle"></i> Running test ${completed + 1} of 5`;
                
                // Select random sample
                const randomSample = samples[Math.floor(Math.random() * samples.length)];
                const quality = 60 + Math.random() * 30;
                const light = 30 + Math.random() * 100;
                const uv = 70 + Math.random() * 20;
                
                // Update sliders visually
                qualitySlider.value = Math.round(quality);
                lightSlider.value = Math.round(light);
                uvSlider.value = Math.round(uv);
                qualityValue.textContent = `${Math.round(quality)}%`;
                lightValue.textContent = `${Math.round(light)} lux`;
                uvValue.textContent = `${Math.round(uv)}%`;
                
                // Select the sample button
                sampleButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.sample === randomSample);
                });
                selectedSample = randomSample;
                
                // Run test
                const result = detector.simulateTest(randomSample, quality, light, uv);
                
                // Display last result
                if (completed === 4) {
                    displayResults(result);
                }
                
                completed++;
                
                // Update UI
                updateTestHistory();
                updateStatistics();
                updateCharts();
                
            }, 1500);
        }
        
        function resetLab() {
            if (confirm('Reset the entire laboratory? This will clear all test history and statistics.')) {
                detector.reset();
                updateTestHistory();
                updateStatistics();
                updateCharts();
                
                // Hide results
                resultsPlaceholder.style.display = 'flex';
                resultsContent.style.display = 'none';
                
                // Reset status
                const statusIndicator = document.querySelector('.status-indicator');
                statusIndicator.className = 'status-indicator status-online';
                statusIndicator.innerHTML = '<i class="fas fa-circle"></i> System Online - Ready for Testing';
                
                showNotification('Laboratory has been reset. Ready for new tests!');
            }
        }
        
        function displayResults(result) {
            // Show results panel
            resultsPlaceholder.style.display = 'none';
            resultsContent.style.display = 'block';
            
            // Update result display
            const polymerInfo = detector.polymerSignatures[result.predictedPolymer];
            resultPolymer.textContent = polymerInfo.name;
            resultPolymer.className = `result-title polymer-${result.predictedPolymer.toLowerCase()}`;
            
            resultConfidence.textContent = `${(result.confidence * 100).toFixed(1)}%`;
            
            rValue.textContent = result.rgb.R;
            gValue.textContent = result.rgb.G;
            bValue.textContent = result.rgb.B;
            
            // Update interpretation
            let interpretation = '';
            if (result.predictedPolymer === 'NONE') {
                interpretation = '✅ Water appears clean - no microplastics detected. This is a good baseline measurement.';
            } else {
                interpretation = `⚠️ Microplastics detected: ${polymerInfo.name}. ${polymerInfo.description}<br><br>
                                 <strong>Common Sources:</strong> ${polymerInfo.commonSources}`;
            }
            resultInterpretation.innerHTML = `<strong><i class="fas fa-microscope"></i> Interpretation:</strong> ${interpretation}`;
            
            // Update probability bars
            updateProbabilityBars(result.probabilities);
        }
        
        function updateProbabilityBars(probabilities) {
            probabilityBars.innerHTML = '';
            
            // Sort by probability (descending)
            const sorted = Object.entries(probabilities)
                .sort((a, b) => b[1] - a[1]);
            
            sorted.forEach(([polymer, prob]) => {
                const polymerInfo = detector.polymerSignatures[polymer];
                const percentage = (prob * 100).toFixed(1);
                
                const bar = document.createElement('div');
                bar.className = 'probability-bar';
                bar.innerHTML = `
                    <div class="probability-label">
                        <span class="probability-name">${polymerInfo.name}</span>
                        <span class="probability-value">${percentage}%</span>
                    </div>
                    <div class="probability-meter">
                        <div class="probability-fill" style="width: ${percentage}%; background: ${polymerInfo.color};"></div>
                    </div>
                `;
                
                probabilityBars.appendChild(bar);
            });
        }
        
        function updateTestHistory() {
            testHistoryDiv.innerHTML = '<h3 style="margin-bottom: 15px;"><i class="fas fa-history"></i> Recent Tests</h3>';
            
            if (detector.testHistory.length === 0) {
                testHistoryDiv.innerHTML += '<p style="color: var(--gray); text-align: center; padding: 20px;">No tests yet. Run your first test!</p>';
                return;
            }
            
            detector.testHistory.forEach(result => {
                const polymerInfo = detector.polymerSignatures[result.predictedPolymer];
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div>
                        <div class="history-polymer" style="color: ${polymerInfo.color}">
                            ${polymerInfo.name}
                        </div>
                        <div class="history-time">
                            ${result.timestamp} | Quality: ${result.conditions.quality}%
                        </div>
                    </div>
                    <div class="history-confidence">${(result.confidence * 100).toFixed(0)}%</div>
                `;
                testHistoryDiv.appendChild(item);
            });
        }
        
        function updateStatistics() {
            const stats = detector.getStatistics();
            
            statTests.textContent = stats.tests;
            statDetections.textContent = stats.detections;
            statRate.textContent = `${stats.detectionRate.toFixed(1)}%`;
            statConfidence.textContent = `${stats.avgConfidence.toFixed(1)}%`;
        }
        
        function initializeCharts() {
            // RGB Chart
            const rgbTrace = {
                x: ['Red', 'Green', 'Blue'],
                y: [185, 92, 42],
                type: 'bar',
                marker: {
                    color: ['#ef4444', '#10b981', '#3b82f6']
                },
                name: 'RGB Values'
            };
            
            const rgbLayout = {
                title: 'RGB Fluorescence Intensity',
                plot_bgcolor: 'rgba(30, 41, 59, 0)',
                paper_bgcolor: 'rgba(30, 41, 59, 0)',
                font: { color: '#e2e8f0' },
                yaxis: {
                    gridcolor: 'rgba(100, 116, 139, 0.3)',
                    range: [0, 255],
                    title: 'Intensity (0-255)'
                },
                xaxis: {
                    gridcolor: 'rgba(100, 116, 139, 0.3)'
                }
            };
            
            Plotly.newPlot(rgbChartContainer, [rgbTrace], rgbLayout);
            
            // History Chart
            const historyTrace = {
                x: [],
                y: [],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Confidence',
                line: { color: '#3b82f6', width: 3 },
                marker: { size: 8, color: '#3b82f6' }
            };
            
            const historyLayout = {
                title: 'Test Confidence Over Time',
                plot_bgcolor: 'rgba(30, 41, 59, 0)',
                paper_bgcolor: 'rgba(30, 41, 59, 0)',
                font: { color: '#e2e8f0' },
                yaxis: {
                    gridcolor: 'rgba(100, 116, 139, 0.3)',
                    range: [0, 100],
                    title: 'Confidence (%)'
                },
                xaxis: {
                    gridcolor: 'rgba(100, 116, 139, 0.3)',
                    title: 'Test Sequence'
                }
            };
            
            Plotly.newPlot(historyChartContainer, [historyTrace], historyLayout);
            
            // Polymer Distribution Chart
            const polymerTrace = {
                labels: ['PE', 'PP', 'PET', 'PS', 'PVC', 'Clean Water'],
                values: [1, 1, 1, 1, 1, 1],
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#94a3b8']
                }
            };
            
            const polymerLayout = {
                title: 'Polymer Distribution',
                plot_bgcolor: 'rgba(30, 41, 59, 0)',
                paper_bgcolor: 'rgba(30, 41, 59, 0)',
                font: { color: '#e2e8f0' },
                showlegend: true
            };
            
            Plotly.newPlot(polymerChartContainer, [polymerTrace], polymerLayout);
            
            // Confidence Distribution Chart
            const confidenceTrace = {
                x: [],
                y: [],
                type: 'histogram',
                name: 'Confidence Distribution',
                marker: { color: '#3b82f6' }
            };
            
            const confidenceLayout = {
                title: 'Confidence Distribution',
                plot_bgcolor: 'rgba(30, 41, 59, 0)',
                paper_bgcolor: 'rgba(30, 41, 59, 0)',
                font: { color: '#e2e8f0' },
                yaxis: {
                    gridcolor: 'rgba(100, 116, 139, 0.3)',
                    title: 'Frequency'
                },
                xaxis: {
                    gridcolor: 'rgba(100, 116, 139, 0.3)',
                    range: [0, 100],
                    title: 'Confidence (%)'
                }
            };
            
            Plotly.newPlot(confidenceChartContainer, [confidenceTrace], confidenceLayout);
        }
        
        function updateCharts() {
            if (detector.testHistory.length === 0) return;
            
            const latestResult = detector.testHistory[0];
            
            // Update RGB chart with latest values
            Plotly.restyle(rgbChartContainer, 'y', [[
                latestResult.rgb.R,
                latestResult.rgb.G,
                latestResult.rgb.B
            ]]);
            
            // Update history chart
            const testNumbers = Array.from({length: detector.testHistory.length}, (_, i) => i + 1);
            const confidences = detector.testHistory.map(r => r.confidence * 100).reverse();
            
            Plotly.restyle(historyChartContainer, {
                x: [testNumbers],
                y: [confidences]
            });
            
            // Update polymer distribution
            if (detector.testHistory.length > 0) {
                const polymerCounts = {
                    'PE': 0, 'PP': 0, 'PET': 0, 
                    'PS': 0, 'PVC': 0, 'NONE': 0
                };
                
                detector.testHistory.forEach(result => {
                    polymerCounts[result.predictedPolymer]++;
                });
                
                Plotly.restyle(polymerChartContainer, 'values', [[
                    polymerCounts['PE'],
                    polymerCounts['PP'],
                    polymerCounts['PET'],
                    polymerCounts['PS'],
                    polymerCounts['PVC'],
                    polymerCounts['NONE']
                ]]);
            }
            
            // Update confidence distribution
            if (detector.testHistory.length > 0) {
                const allConfidences = detector.testHistory.map(r => r.confidence * 100);
                Plotly.restyle(confidenceChartContainer, 'x', [allConfidences]);
            }
        }
        
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(15, 23, 42, 0.95);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                border-left: 5px solid #3b82f6;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `<i class="fas fa-info-circle" style="margin-right: 10px; color: #3b82f6;"></i>${message}`;
            
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }
        
        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize with a sample test
        window.addEventListener('load', () => {
            // Run a sample test after a short delay
            setTimeout(() => {
                const sampleResult = detector.simulateTest('PE', 80, 50, 85);
                displayResults(sampleResult);
                updateTestHistory();
                updateStatistics();
                updateCharts();
                
                // Show welcome message
                showNotification('Welcome to the Virtual Microplastic Lab! Try testing different samples.');
            }, 1000);
        });
    </script>
</body>
</html>